
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A lightweight ASGI web framework">
      
      
      
      
      <link rel="icon" href="../../images/favicon.ico">
      <meta name="generator" content="mkdocs-1.2.2, mkdocs-material-7.3.1">
    
    
      
        <title>Background Tasks - bareASGI</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.1c75ef36.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../../css/custom.css">
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#background-tasks" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="bareASGI" class="md-header__button md-logo" aria-label="bareASGI" data-md-component="logo">
      
  <img src="../../images/peach.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            bareASGI
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Background Tasks
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
      <div class="md-header__source">
        
<a href="https://github.com/rob-blackbourn/bareASGI" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    rob-blackbourn/bareASGI
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="bareASGI" class="md-nav__button md-logo" aria-label="bareASGI" data-md-component="logo">
      
  <img src="../../images/peach.svg" alt="logo">

    </a>
    bareASGI
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/rob-blackbourn/bareASGI" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    rob-blackbourn/bareASGI
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Lightweight ASGI Web Framework
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          User Guide
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="User Guide" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          User Guide
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/installation/" class="md-nav__link">
        Installation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/getting-started/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/usage/" class="md-nav__link">
        Usage
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/optional-packages/" class="md-nav__link">
        Optional Packages
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/asgi/" class="md-nav__link">
        ASGI
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/application/" class="md-nav__link">
        Application
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/io/" class="md-nav__link">
        Reading and Writing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/routing/" class="md-nav__link">
        Routing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/middleware/" class="md-nav__link">
        Middleware
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/background-tasks/" class="md-nav__link">
        Background Tasks
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/decorators/" class="md-nav__link">
        Decorators
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/h2/" class="md-nav__link">
        HTTP/2
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/h3/" class="md-nav__link">
        HTTP/3 - QUIC
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/server-sent-events/" class="md-nav__link">
        Server Sent Events
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/ssl/" class="md-nav__link">
        SSL/HTTPS
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Tutorial
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Tutorial" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Tutorial
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        bareASGI-tutorial
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/" class="md-nav__link">
        Getting Started with bareASGI
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../simple-rest/" class="md-nav__link">
        Simple REST
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../lifespan/" class="md-nav__link">
        Lifespan
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Background Tasks
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Background Tasks
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-task" class="md-nav__link">
    The Task
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-startup-handler" class="md-nav__link">
    The Startup Handler
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-shutdown-handler" class="md-nav__link">
    The Shutdown Handler
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-program" class="md-nav__link">
    The Program
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canceling" class="md-nav__link">
    Canceling
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cancel-or-shutdown-event" class="md-nav__link">
    Cancel or Shutdown Event?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gotcha" class="md-nav__link">
    Gotcha!
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-next" class="md-nav__link">
    What next?
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../headers/" class="md-nav__link">
        None
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../https/" class="md-nav__link">
        HTTPS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../middleware/" class="md-nav__link">
        Middleware
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../websockets/" class="md-nav__link">
        Web Sockets
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../headers/" class="md-nav__link">
        Headers (including cookies)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cors/" class="md-nav__link">
        Cross-Origin Resource Sharing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../jinja2/" class="md-nav__link">
        Jinja2 Templating
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../static-files/" class="md-nav__link">
        Static Files
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../server-sent-events/" class="md-nav__link">
        Server Sent Events
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../streaming-fetch/" class="md-nav__link">
        Streaming Fetch
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../compression/" class="md-nav__link">
        Compression
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../controller-classes/" class="md-nav__link">
        Controller Classes
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          API
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="API" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          API
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/bareasgi/" class="md-nav__link">
        bareasgi
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/bareasgi.basic_router/" class="md-nav__link">
        bareasgi.basic_router
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-task" class="md-nav__link">
    The Task
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-startup-handler" class="md-nav__link">
    The Startup Handler
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-shutdown-handler" class="md-nav__link">
    The Shutdown Handler
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-program" class="md-nav__link">
    The Program
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canceling" class="md-nav__link">
    Canceling
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cancel-or-shutdown-event" class="md-nav__link">
    Cancel or Shutdown Event?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gotcha" class="md-nav__link">
    Gotcha!
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-next" class="md-nav__link">
    What next?
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="background-tasks">Background Tasks<a class="headerlink" href="#background-tasks" title="Permanent link">&para;</a></h1>
<p>Some times it is necessary to run background tasks. For example to poll a data
source, or listen to a data stream.</p>
<p>The following example starts a background task when the server starts up,
then gracefully terminates it when the server shuts down.</p>
<p>The source code for the following example can be found
<a href="../../examples/lifespan_nt.py">here</a>
(and here <a href="../../examples/lifespan.py">here</a> with typing).</p>
<h2 id="the-task">The Task<a class="headerlink" href="#the-task" title="Permanent link">&para;</a></h2>
<p>The following code provides a dummy task, which just waits for a second then
gets the time. This time I've used the typed code.</p>
<div class="codehilite"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">time_ticker</span><span class="p">(</span><span class="n">info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">shutdown_event</span><span class="p">:</span> <span class="n">Event</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Starting the time ticker&#39;</span><span class="p">)</span>

    <span class="k">while</span> <span class="ow">not</span> <span class="n">shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;now&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;time: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;now&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">shutdown_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Timeout - normal behaviour when waiting with a timeout&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failure - we should not see this exception&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The time ticker has stopped&#39;</span><span class="p">)</span>
</code></pre></div>

<p>Rather than simply cancelling the task, I've used the asyncio
<a href="https://docs.python.org/3/library/asyncio-sync.html#asyncio.Event">Event</a>
to shutdown more gracefully.</p>
<h2 id="the-startup-handler">The Startup Handler<a class="headerlink" href="#the-startup-handler" title="Permanent link">&para;</a></h2>
<p>First we create the event and store it in the application's <code>info</code>.</p>
<p>Then we create the task with
<a href="https://docs.python.org/3/library/asyncio-task.html#asyncio.create_task"><code>asyncio.create_task</code></a>
and store the task in the application's <code>info</code>.</p>
<p>When the task is created it will be scheduled to run. Any time the task
<em>awaits</em>, it gives up control and other tasks which are ready to run can
proceed.</p>
<div class="codehilite"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">time_ticker_startup_handler</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1"># Create an event that can be set when the background task should shutdown.</span>
    <span class="n">shutdown_event</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
    <span class="n">request</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;shutdown_event&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shutdown_event</span>

    <span class="c1"># Create the background task.</span>
    <span class="n">request</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;time_ticker_task&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
        <span class="n">time_ticker</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">shutdown_event</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div>

<p>Note that the shutdown event was created in the startup handler. This is
<strong>critical</strong>. I'll discuss why in the "Gotcha!" section.</p>
<h2 id="the-shutdown-handler">The Shutdown Handler<a class="headerlink" href="#the-shutdown-handler" title="Permanent link">&para;</a></h2>
<p>Here is the code for the shutdown handler.</p>
<div class="codehilite"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">time_ticker_shutdown_handler</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1"># Set the shutdown event so the background task can stop gracefully.</span>
    <span class="n">shutdown_event</span><span class="p">:</span> <span class="n">Event</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;shutdown_event&#39;</span><span class="p">]</span>
    <span class="n">shutdown_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

    <span class="c1"># Wait for the background task to finish.</span>
    <span class="n">time_ticker_task</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;time_ticker_task&#39;</span><span class="p">]</span>
    <span class="k">await</span> <span class="n">time_ticker_task</span>
</code></pre></div>

<p>First we retrieve the event from the application's info and set it. In the
background task the loop will exit when it next checks the event.</p>
<div class="codehilite"><pre><span></span><code><span class="k">while</span> <span class="ow">not</span> <span class="n">shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
        <span class="o">...</span>
</code></pre></div>

<p>Next we fetch the task from the applications info and <code>await</code> it. When the
next timeout occurs in the background task it will exit it's loop, and the
background task gracefully shuts down.</p>
<h2 id="the-program">The Program<a class="headerlink" href="#the-program" title="Permanent link">&para;</a></h2>
<p>Here is the full code.</p>
<p>I've added a request handler which returns the time stored by the background
task to demonstrate that the web server is still able to handle requests.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">asyncio</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">uvicorn</span>

<span class="kn">from</span> <span class="nn">bareasgi</span> <span class="kn">import</span> <span class="n">Application</span><span class="p">,</span> <span class="n">text_writer</span><span class="p">,</span> <span class="n">HttpResponse</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;background_tasks&#39;</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">time_ticker</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">shutdown_event</span><span class="p">):</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Starting the time ticker&#39;</span><span class="p">)</span>

    <span class="k">while</span> <span class="ow">not</span> <span class="n">shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
        <span class="c1"># Store the time</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;now&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;time: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;now&#39;</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">shutdown_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s1">&#39;Timeout - normal behaviour when waiting with a timeout&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Failure - we should not see this exception&#39;</span><span class="p">)</span>

    <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;The time ticker has stopped&#39;</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">time_ticker_startup_handler</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1"># Create an event that can be set when the background task should shutdown.</span>
    <span class="n">shutdown_event</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
    <span class="n">request</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;shutdown_event&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shutdown_event</span>

    <span class="c1"># Create the background task.</span>
    <span class="n">request</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;time_ticker_task&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
        <span class="n">time_ticker</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">shutdown_event</span><span class="p">)</span>
    <span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">time_ticker_shutdown_handler</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1"># Set the shutdown event so the background task can stop gracefully.</span>
    <span class="n">shutdown_event</span><span class="p">:</span> <span class="n">Event</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;shutdown_event&#39;</span><span class="p">]</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Stopping the time_ticker&#39;</span><span class="p">)</span>
    <span class="n">shutdown_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

    <span class="c1"># Wait for the background task to finish.</span>
    <span class="n">time_ticker_task</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;time_ticker_task&#39;</span><span class="p">]</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Waiting for time_ticker&#39;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">time_ticker_task</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;time_ticker shutdown&#39;</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">http_request_callback</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;content-type&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;text/plain&#39;</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">text_writer</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Last time tick: </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;now&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Application</span><span class="p">(</span>
    <span class="n">startup_handlers</span><span class="o">=</span><span class="p">[</span><span class="n">time_ticker_startup_handler</span><span class="p">],</span>
    <span class="n">shutdown_handlers</span><span class="o">=</span><span class="p">[</span><span class="n">time_ticker_shutdown_handler</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">http_router</span><span class="o">.</span><span class="n">add</span><span class="p">({</span><span class="s1">&#39;GET&#39;</span><span class="p">},</span> <span class="s1">&#39;/{rest:path}&#39;</span><span class="p">,</span> <span class="n">http_request_callback</span><span class="p">)</span>

<span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">9009</span><span class="p">)</span>
</code></pre></div>

<h2 id="canceling">Canceling<a class="headerlink" href="#canceling" title="Permanent link">&para;</a></h2>
<p>Rather than using an event we could have just cancelled the task.</p>
<div class="codehilite"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">time_ticker_shutdown_handler</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="n">time_ticker_task</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;time_ticker_task&#39;</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">time_ticker_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">time_ticker_task</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancellationError</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div>

<p>The background task might then look as follows.</p>
<div class="codehilite"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">time_ticker</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">shutdown_event</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Store the time</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;now&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;time: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;now&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancellationError</span><span class="p">:</span>
            <span class="k">return</span> <span class="c1"># Catch the task.cancel() and exit</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failure - we should not see this exception&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The time ticker has stopped&#39;</span><span class="p">)</span>
</code></pre></div>

<h2 id="cancel-or-shutdown-event">Cancel or Shutdown Event?<a class="headerlink" href="#cancel-or-shutdown-event" title="Permanent link">&para;</a></h2>
<p>In the above example cancelling the task would have been appropriate. Nothing
bad would happen, and no data would be lost.</p>
<p>The event approach is useful where cancelling the task would result in some
kind of corrupt state. For example if a database write was in progress, or
a message queue was being serviced.</p>
<h2 id="gotcha">Gotcha!<a class="headerlink" href="#gotcha" title="Permanent link">&para;</a></h2>
<p>If we had a large program running many background tasks with multiple startup
handlers, it would seem reasonable to create the shutdown event right at the
start.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># This won&#39;t work!</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Application</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;shutdown_event&#39;</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()})</span>
</code></pre></div>

<p>Unfortunately this won't work and will lead to hours of frustration.</p>
<p>When an ASGI server starts it creates a <strong>new</strong> event loop. However the
<code>asyncio.Event()</code> call attached the event to the existing event loop. At the
point the event is awaited you will get an error telling you the coroutine was
attached to another event loop, which is true, but not helpful!</p>
<p>This is true for anything that can be awaited. They must all be created in the
context of the ASGI server's event loop.</p>
<h2 id="what-next">What next?<a class="headerlink" href="#what-next" title="Permanent link">&para;</a></h2>
<p>Either go back to the <a href="../">table of contents</a> or go
to the <a href="../https/">https</a> tutorial.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../lifespan/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Lifespan" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Lifespan
            </div>
          </div>
        </a>
      
      
        
        <a href="../headers/" class="md-footer__link md-footer__link--next" aria-label="Next: None" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              None
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        
          Made with
          <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
            Material for MkDocs
          </a>
        
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.e99e714c.min.js", "version": {"provider": "mike", "default": "stable"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.c7d1b464.min.js"></script>
      
    
  </body>
</html>